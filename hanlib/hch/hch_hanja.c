#include "hch.h"

#define HANGULCODE      0
#define NOOFHANJA       1
#define NOOFACCHANJA    2

static HANCHAR hanjaTbl[474][3] = {
    { 34913U,  29,    0 }, { 34914U,  11,   29 }, { 34917U,  24,   40 },
    { 34921U,  10,   64 }, { 34929U,  20,   74 }, { 34931U,   6,   94 },
    { 34935U,  24,  100 }, { 34945U,  20,  124 }, { 34946U,   2,  144 },
    { 34967U,   4,  146 }, { 34978U,   1,  150 }, { 35041U,  17,  151 },
    { 35045U,  12,  168 }, { 35049U,   4,  180 }, { 35057U,   7,  184 },
    { 35059U,   3,  191 }, { 35137U,   3,  194 }, { 35170U,   7,  197 },
    { 35173U,  11,  204 }, { 35177U,   6,  215 }, { 35185U,   6,  221 },
    { 35191U,  45,  227 }, { 35201U,  24,  272 }, { 35233U,  39,  296 },
    { 35234U,   7,  335 }, { 35237U,  10,  342 }, { 35241U,   3,  352 },
    { 35255U,  16,  355 }, { 35256U,   1,  371 }, { 35265U,  12,  372 },
    { 35266U,   4,  384 }, { 35269U,  17,  388 }, { 35273U,   4,  405 },
    { 35287U,  13,  409 }, { 35297U,   3,  422 }, { 35393U,   9,  425 },
    { 35415U,   4,  434 }, { 35425U,  25,  438 }, { 35457U,  54,  463 },
    { 35458U,   6,  517 }, { 35461U,   6,  523 }, { 35465U,   4,  529 },
    { 35479U,   6,  533 }, { 35493U,  10,  539 }, { 35497U,   5,  549 },
    { 35521U,   6,  554 }, { 35553U,   6,  560 }, { 35649U,  15,  566 },
    { 35653U,   7,  581 }, { 35657U,   1,  588 }, { 35682U,   7,  589 },
    { 35685U,  15,  596 }, { 35689U,   1,  611 }, { 35697U,  14,  612 },
    { 35699U,   7,  626 }, { 35703U,   4,  633 }, { 35745U,  64,  637 },
    { 35749U,   1,  701 }, { 35753U,   4,  702 }, { 35761U,   1,  706 },
    { 36770U,   1,  707 }, { 36961U,  15,  708 }, { 36962U,   8,  723 },
    { 36965U,   9,  731 }, { 36969U,   2,  740 }, { 36977U,   9,  742 },
    { 36979U,   5,  751 }, { 36983U,   7,  756 }, { 36993U,   6,  763 },
    { 37015U,   1,  769 }, { 37217U,   1,  770 }, { 37221U,   3,  771 },
    { 37233U,   4,  774 }, { 37239U,   2,  778 }, { 37281U,  18,  780 },
    { 37282U,   6,  798 }, { 37285U,   1,  804 }, { 37303U,   7,  805 },
    { 37441U,   6,  812 }, { 37473U,   1,  818 }, { 37505U,   8,  819 },
    { 37509U,   1,  827 }, { 37513U,   1,  828 }, { 37697U,   2,  829 },
    { 37730U,   2,  831 }, { 37745U,   1,  833 }, { 37751U,   6,  834 },
    { 37793U,   2,  840 }, { 37794U,   2,  842 }, { 37985U,   2,  844 },
    { 37989U,  20,  846 }, { 37993U,   5,  866 }, { 38001U,  17,  871 },
    { 38003U,   5,  888 }, { 38007U,  11,  893 }, { 38017U,  16,  904 },
    { 38018U,   1,  920 }, { 38114U,   2,  921 }, { 38305U,  40,  923 },
    { 38306U,  10,  963 }, { 38309U,  10,  973 }, { 38313U,   2,  983 },
    { 38327U,  17,  985 }, { 38529U,  11, 1002 }, { 38533U,   6, 1013 },
    { 38754U,   1, 1019 }, { 38775U,   9, 1020 }, { 40033U,   9, 1029 },
    { 40034U,   9, 1038 }, { 40037U,   9, 1047 }, { 40041U,   2, 1056 },
    { 40049U,  10, 1058 }, { 40051U,   3, 1068 }, { 40055U,   8, 1071 },
    { 40065U,   4, 1079 }, { 40087U,   2, 1083 }, { 40098U,   1, 1085 },
    { 40119U,  13, 1086 }, { 40289U,  18, 1099 }, { 40290U,   7, 1117 },
    { 40293U,  12, 1124 }, { 40297U,   6, 1136 }, { 40305U,   5, 1142 },
    { 40307U,   1, 1147 }, { 40311U,  18, 1148 }, { 40321U,   5, 1166 },
    { 40353U,  18, 1171 }, { 40354U,   7, 1189 }, { 40357U,   1, 1196 },
    { 40375U,   7, 1197 }, { 40513U,   8, 1204 }, { 40545U,  12, 1212 },
    { 40567U,   1, 1224 }, { 40577U,  13, 1225 }, { 40769U,  14, 1238 },
    { 40770U,   3, 1252 }, { 40773U,   6, 1255 }, { 40777U,   4, 1261 },
    { 40791U,   1, 1265 }, { 40802U,   2, 1266 }, { 40817U,   1, 1268 },
    { 40823U,   6, 1269 }, { 40865U,  26, 1275 }, { 40869U,   9, 1301 },
    { 40881U,   5, 1310 }, { 40883U,   4, 1315 }, { 41057U,   8, 1319 },
    { 41058U,   6, 1327 }, { 41061U,  19, 1333 }, { 41065U,   7, 1352 },
    { 41079U,  12, 1359 }, { 41089U,  14, 1371 }, { 41090U,   5, 1385 },
    { 41111U,   6, 1390 }, { 41314U,   2, 1396 }, { 41317U,  11, 1398 },
    { 41321U,   2, 1409 }, { 41335U,  15, 1411 }, { 41345U,   1, 1426 },
    { 41377U,  24, 1427 }, { 41378U,   7, 1451 }, { 41385U,   2, 1458 },
    { 41399U,   3, 1460 }, { 41569U,  12, 1463 }, { 41601U,  22, 1475 },
    { 41602U,   2, 1497 }, { 41605U,  12, 1499 }, { 41609U,   3, 1511 },
    { 41889U,  19, 1514 }, { 41893U,  13, 1533 }, { 41897U,   3, 1546 },
    { 42082U,  19, 1549 }, { 42085U,  25, 1568 }, { 42089U,  11, 1593 },
    { 42103U,  28, 1604 }, { 42113U,  20, 1632 }, { 42114U,   8, 1652 },
    { 42213U,  10, 1660 }, { 42217U,   4, 1670 }, { 42225U,   9, 1674 },
    { 42227U,   2, 1683 }, { 42338U,  11, 1685 }, { 42341U,   7, 1696 },
    { 42345U,   4, 1703 }, { 42359U,  17, 1707 }, { 42401U,  16, 1724 },
    { 42402U,  17, 1740 }, { 42405U,   1, 1757 }, { 42409U,   1, 1758 },
    { 42423U,  16, 1759 }, { 42625U,  43, 1775 }, { 42626U,   1, 1818 },
    { 42629U,  19, 1819 }, { 42633U,   5, 1838 }, { 42647U,   6, 1843 },
    { 42913U,  43, 1849 }, { 42917U,  14, 1892 }, { 42935U,   4, 1906 },
    { 44129U,  60, 1910 }, { 44130U,   4, 1970 }, { 44133U,  12, 1974 },
    { 44137U,   5, 1986 }, { 44145U,   8, 1991 }, { 44147U,   4, 1999 },
    { 44151U,  31, 2003 }, { 44161U,   3, 2034 }, { 44162U,   5, 2037 },
    { 44183U,   5, 2042 }, { 44257U,  30, 2047 }, { 44258U,  15, 2077 },
    { 44261U,  32, 2092 }, { 44265U,  13, 2124 }, { 44273U,   8, 2137 },
    { 44275U,   4, 2145 }, { 44279U,  18, 2149 }, { 44353U,   9, 2167 },
    { 44449U,  37, 2176 }, { 44450U,   9, 2213 }, { 44453U,   6, 2222 },
    { 44457U,   1, 2228 }, { 44471U,   8, 2229 }, { 44513U,   5, 2237 },
    { 44609U,   2, 2242 }, { 44673U,  61, 2244 }, { 44674U,  12, 2305 },
    { 44677U,  27, 2317 }, { 44681U,   4, 2344 }, { 44695U,   3, 2348 },
    { 44905U,   3, 2351 }, { 44915U,   5, 2354 }, { 44919U,  10, 2359 },
    { 44961U,  28, 2369 }, { 44962U,  15, 2397 }, { 44965U,  24, 2412 },
    { 44969U,   4, 2436 }, { 44977U,  10, 2440 }, { 44979U,   3, 2450 },
    { 45175U,   1, 2453 }, { 45985U,   1, 2454 }, { 46177U,  18, 2455 },
    { 46178U,  14, 2473 }, { 46181U,  10, 2487 }, { 46185U,   4, 2497 },
    { 46193U,   8, 2501 }, { 46195U,   4, 2509 }, { 46199U,   7, 2513 },
    { 46209U,  11, 2520 }, { 46210U,   7, 2531 }, { 46231U,   4, 2538 },
    { 46241U,  11, 2542 }, { 46242U,   9, 2553 }, { 46263U,  31, 2562 },
    { 46305U,  10, 2593 }, { 46306U,   5, 2603 }, { 46309U,   6, 2608 },
    { 46313U,   2, 2614 }, { 46321U,   6, 2616 }, { 46323U,   2, 2622 },
    { 46405U,   1, 2624 }, { 46433U,  24, 2625 }, { 46434U,  13, 2649 },
    { 46437U,  43, 2662 }, { 46441U,  10, 2705 }, { 46449U,  15, 2715 },
    { 46451U,   4, 2730 }, { 46455U,  40, 2734 }, { 46465U,  24, 2774 },
    { 46497U,  30, 2798 }, { 46498U,   5, 2828 }, { 46501U,   6, 2833 },
    { 46505U,   1, 2839 }, { 46519U,   9, 2840 }, { 46529U,   8, 2849 },
    { 46533U,  18, 2857 }, { 46537U,   1, 2875 }, { 46551U,   5, 2876 },
    { 46561U,   4, 2881 }, { 46657U,   5, 2885 }, { 46689U,  38, 2890 },
    { 46690U,   6, 2928 }, { 46711U,  24, 2934 }, { 46721U,  32, 2958 },
    { 46722U,   9, 2990 }, { 46725U,  13, 2999 }, { 46729U,   3, 3012 },
    { 46743U,   2, 3015 }, { 46757U,  27, 3017 }, { 46761U,   3, 3044 },
    { 46817U,  25, 3047 }, { 46913U,  56, 3072 }, { 46914U,   7, 3128 },
    { 46917U,  13, 3135 }, { 46921U,   5, 3148 }, { 46935U,   5, 3153 },
    { 46949U,   7, 3158 }, { 46953U,   1, 3165 }, { 46961U,   6, 3166 },
    { 46963U,   3, 3172 }, { 46967U,   4, 3175 }, { 46977U,  19, 3179 },
    { 47009U,  38, 3198 }, { 47010U,   8, 3236 }, { 47013U,  24, 3244 },
    { 47017U,   9, 3268 }, { 47025U,  11, 3277 }, { 47027U,   5, 3288 },
    { 47031U,   4, 3293 }, { 47201U,  26, 3297 }, { 47202U,  13, 3323 },
    { 47205U,   5, 3336 }, { 47217U,   6, 3341 }, { 47219U,   1, 3347 },
    { 47223U,  37, 3348 }, { 47233U,  17, 3385 }, { 47255U,   4, 3402 },
    { 47329U,  28, 3406 }, { 47330U,  25, 3434 }, { 47333U,  41, 3459 },
    { 47337U,   8, 3500 }, { 47345U,   9, 3508 }, { 47347U,   3, 3517 },
    { 47351U,  55, 3520 }, { 47425U,  23, 3575 }, { 47521U,  46, 3598 },
    { 47522U,   4, 3644 }, { 47525U,   2, 3648 }, { 47529U,   3, 3650 },
    { 47543U,  17, 3653 }, { 47553U,   5, 3670 }, { 47681U,   1, 3675 },
    { 47745U,  40, 3676 }, { 47746U,   2, 3716 }, { 47749U,  19, 3718 },
    { 47753U,   1, 3737 }, { 47767U,   4, 3738 }, { 47970U,   1, 3742 },
    { 47977U,   1, 3743 }, { 47987U,   3, 3744 }, { 47991U,  11, 3747 },
    { 48033U,  34, 3758 }, { 48034U,   5, 3792 }, { 48037U,  35, 3797 },
    { 48041U,  15, 3832 }, { 48049U,   2, 3847 }, { 48051U,   7, 3849 },
    { 48055U,   3, 3856 }, { 49249U,  15, 3859 }, { 49250U,   7, 3874 },
    { 49253U,  15, 3881 }, { 49257U,   5, 3896 }, { 49265U,  10, 3901 },
    { 49271U,  22, 3911 }, { 49281U,  12, 3933 }, { 49282U,   4, 3945 },
    { 49377U,   4, 3949 }, { 49378U,  15, 3953 }, { 49381U,  19, 3968 },
    { 49385U,  10, 3987 }, { 49393U,  10, 3997 }, { 49395U,  10, 4007 },
    { 49399U,   8, 4017 }, { 49473U,  10, 4025 }, { 49569U,  27, 4035 },
    { 49570U,   6, 4062 }, { 49573U,   3, 4068 }, { 49591U,  11, 4071 },
    { 49609U,   1, 4082 }, { 49729U,   3, 4083 }, { 49793U,  23, 4086 },
    { 49794U,  12, 4109 }, { 49797U,   3, 4121 }, { 49801U,   3, 4124 },
    { 49815U,   6, 4127 }, { 49857U,   3, 4133 }, { 49889U,  15, 4136 },
    { 50018U,   5, 4151 }, { 50039U,   1, 4156 }, { 50081U,  24, 4157 },
    { 50082U,   3, 4181 }, { 50085U,   1, 4184 }, { 50089U,   3, 4185 },
    { 50097U,   9, 4188 }, { 50099U,   1, 4197 }, { 50103U,   2, 4198 },
    { 50657U,   1, 4200 }, { 51297U,  14, 4201 }, { 51298U,  16, 4215 },
    { 51301U,  10, 4231 }, { 51305U,   2, 4241 }, { 51313U,   4, 4243 },
    { 51315U,   3, 4247 }, { 51319U,   5, 4250 }, { 51329U,  14, 4255 },
    { 51330U,   3, 4269 }, { 51351U,   1, 4272 }, { 51425U,   1, 4273 },
    { 51617U,   4, 4274 }, { 51639U,   7, 4278 }, { 51777U,   6, 4285 },
    { 51841U,   6, 4291 }, { 52066U,   2, 4297 }, { 52081U,   1, 4299 },
    { 52321U,  16, 4300 }, { 52325U,   9, 4316 }, { 52329U,   3, 4325 },
    { 52353U,  11, 4328 }, { 52375U,   4, 4339 }, { 52386U,   1, 4343 },
    { 52581U,  10, 4344 }, { 52593U,   1, 4354 }, { 52599U,   5, 4355 },
    { 52609U,  10, 4360 }, { 52641U,  28, 4370 }, { 52642U,   6, 4398 },
    { 52833U,  14, 4404 }, { 52881U,   2, 4418 }, { 52887U,   5, 4420 },
    { 53153U,   7, 4425 }, { 53161U,  10, 4432 }, { 53171U,   2, 4442 },
    { 53345U,  14, 4444 }, { 53346U,   5, 4458 }, { 53349U,  14, 4463 },
    { 53353U,   2, 4477 }, { 53361U,  12, 4479 }, { 53363U,   7, 4491 },
    { 53367U,  17, 4498 }, { 53377U,  18, 4515 }, { 53378U,   2, 4533 },
    { 53399U,   5, 4535 }, { 53431U,   9, 4540 }, { 53473U,   4, 4549 },
    { 53477U,   4, 4553 }, { 53481U,   1, 4557 }, { 53489U,   2, 4558 },
    { 53602U,   4, 4560 }, { 53605U,  21, 4564 }, { 53609U,   4, 4585 },
    { 53617U,   1, 4589 }, { 53619U,  12, 4590 }, { 53623U,  20, 4602 },
    { 53633U,   9, 4622 }, { 53665U,  41, 4631 }, { 53666U,   3, 4672 },
    { 53669U,   6, 4675 }, { 53673U,   3, 4681 }, { 53687U,  10, 4684 },
    { 53697U,  14, 4694 }, { 53698U,   6, 4708 }, { 53701U,  17, 4714 },
    { 53705U,   5, 4731 }, { 53719U,  24, 4736 }, { 53825U,  20, 4760 },
    { 53826U,   2, 4780 }, { 53847U,   3, 4782 }, { 53857U,  13, 4785 },
    { 53889U,  13, 4798 }, { 53893U,  10, 4811 }, { 53911U,   1, 4821 },
    { 53925U,   4, 4822 }, { 53953U,   3, 4826 }, { 53985U,   8, 4829 },
    { 54081U,   5, 4837 }, { 54089U,   3, 4842 }, { 54103U,   5, 4845 },
    { 54114U,   1, 4850 }, { 54117U,   4, 4851 }, { 54121U,   4, 4855 },
    { 54129U,   3, 4859 }, { 54131U,   4, 4862 }, { 54135U,   1, 4866 },
    { 54145U,  20, 4867 }, { 54185U,   1, 4887 }, { HCH_SINGLE_SPACE, 0, 4888 },
};

int hch_hg2hjpos( HANCHAR hg, int *pos, int *count )
{
    int low = 0, mid, high = 472;

    while (low <= high) {
        mid = (high + low) / 2;
        if (hanjaTbl[mid][HANGULCODE] == hg )      /* Found!      */
        {
            *pos = hanjaTbl[ mid ][ NOOFACCHANJA ];
            *count = hanjaTbl[ mid ][ NOOFHANJA ];

            return 0;
        }
        else if (hanjaTbl[mid][HANGULCODE] > hg)   /* Second part */
            high = mid - 1;
        else                                        /* First part  */
            low = mid + 1;
    }
    return -1;                                    /* Not found!  */
}

HANCHAR hch_pos2hj( int n )
{
    unsigned char hi, lo;

    if(( n < 0 ) || ( n > 4887 ))
        return HCH_SINGLE_SPACE;

    hi = n / 188 + 0xE0;
    lo = n % 188;

    if (lo < 78)    lo += 0x31;
    else            lo = lo - 78 + 0x91;

    return HCHFROM2CH( hi, lo );
}

int hch_ishanja( HANCHAR hj )
{
    unsigned char hi = (hj >> 8), lo = (hj & 0x00FF);

    if (0xE0 <= hi && hi <= 0xF9)
        if ((0x31 <= lo && lo <= 0x7E) || (0x91 <= lo && lo <= 0xFE))
            return 1;

    return 0;
}


HANCHAR hch_hj2hg( HANCHAR hj )
{
    int hi, lo;
    int pos;
    int i;

    if( !hch_ishanja( hj ) )
        return HCH_SINGLE_SPACE;

    hi = ((hj >> 8) - 0xE0) * 188;
    lo = hj & 0x00FF;
    if (lo & 0x80)  lo -= (0x91 - 78);
    else            lo -= 0x31;
    pos = hi + lo;

    for (i = 0; i < 473; i++)
        if ( pos < hanjaTbl[i+1][NOOFACCHANJA]) break;

    return hanjaTbl[i][HANGULCODE];
}


